name: Default CI Workflow

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: 游빍 Tests unitaires
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test:unit

  lighthouse:
    name: 游뚽 Audit Lighthouse
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Lighthouse audit
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            https://mathieusteinmetz.com
          uploadArtifacts: true
          temporaryPublicStorage: false

      - name: Extract Lighthouse scores
        id: lhci_scores
        run: |
          REPORT_PATH=$(find .lighthouseci -name '*.report.json' | head -n 1)
          PERF=$(jq '.categories.performance.score * 100 | floor' "$REPORT_PATH")
          ACCESS=$(jq '.categories.accessibility.score * 100 | floor' "$REPORT_PATH")
          BEST=$(jq '.categories["best-practices"].score * 100 | floor' "$REPORT_PATH")
          SEO=$(jq '.categories.seo.score * 100 | floor' "$REPORT_PATH")
          echo "PERF=$PERF" >> $GITHUB_OUTPUT
          echo "ACCESS=$ACCESS" >> $GITHUB_OUTPUT
          echo "BEST=$BEST" >> $GITHUB_OUTPUT
          echo "SEO=$SEO" >> $GITHUB_OUTPUT

      - name: Post Lighthouse summary comment
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          COMMENT_BODY: |
            游댌 **Lighthouse Audit Summary**
            - 游릭 Performance: ${{ steps.lhci_scores.outputs.PERF }}
            - 游릭 Accessibility: ${{ steps.lhci_scores.outputs.ACCESS }}
            - 游릭 Best Practices: ${{ steps.lhci_scores.outputs.BEST }}
            - 游릭 SEO: ${{ steps.lhci_scores.outputs.SEO }}

            游늯 [Voir le rapport complet dans les Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        run: |
          gh pr comment "$PR_URL" --body "$COMMENT_BODY"
